window.Framework={cache:{},plugins:{},plugin(e,t){this.plugins[e]=t},usePlugin(e,...t){if(this.plugins[e])return this.plugins[e](...t)},async fetchHTML(e){if(this.cache[e])return this.cache[e];try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}`);const n=await t.text();return this.cache[e]=n,n}catch(t){return console.error(t),`\x3c!-- Error loading ${e} --\x3e`}},async processIncludes(e){const t=/<include\s+src=["']([^"']+)["']([^>]*)>(.*?)<\/include>|<include\s+src=["']([^"']+)["']([^>]*)\/>/gs;let n,i=e;for(;null!==(n=t.exec(i));){const e=n[0],s=n[1]||n[4],o=n[2]||n[5]||"",r=n[3]||"";let l=await this.fetchHTML(s);if(r.trim()){const e={},t=/<slot\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/slot>/g;let n,i=!1;for(;null!==(n=t.exec(r));)e[n[1]]=n[2],i=!0;!i&&r.trim()&&(e.default=r);for(const[t,n]of Object.entries(e)){const e=new RegExp(`<slot\\s+name=["']${t}["']\\s*><\\/slot>|<slot\\s+name=["']${t}["']\\s*\\/>`,"g");l=l.replace(e,n)}e.default&&(l=l.replace(/<slot\s*><\/slot>|<slot\s*\/>/g,e.default))}l=l.replace(/<slot[^>]*><\/slot>|<slot[^>]*\/>/g,"");const a=/(\w+)=["']([^"']*)["']/g;let c;const p={};for(;null!==(c=a.exec(o));)p[c[1]]=c[2];for(const[e,t]of Object.entries(p)){const n=new RegExp(`\\{\\{\\s*${e}\\s*\\}\\}`,"g");l=l.replace(n,t)}l=await this.processIncludes(l),i=i.replace(e,l),t.lastIndex=0}return i},async processLayout(e){const t=/<layout\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/layout>/.exec(e);if(t){const e=t[1],n=t[2],i={},s=/<slot\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/slot>/g;let o;for(;null!==(o=s.exec(n));)i[o[1]]=o[2];let r=await this.fetchHTML(`app/Layouts/${e}.html`);for(const[e,t]of Object.entries(i)){const n=new RegExp(`<slot\\s+name=["']${e}["']\\s*><\\/slot>`,"g");r=r.replace(n,t)}return r}return e},transformTemplate:e=>e=(e=(e=(e=(e=e.replace(/\{\{\s*([^}]+)\s*\}\}/g,'<span x-text="$1"></span>')).replace(/{%\s*if\s+([^%]+)\s*%}/g,'<template x-if="$1">')).replace(/{%\s*endif\s*%}/g,"</template>")).replace(/{%\s*for\s+([^%]+)\s*%}/g,'<template x-for="$1">')).replace(/{%\s*endfor\s*%}/g,"</template>"),sanitize:e=>DOMPurify.sanitize(e,{ADD_TAGS:["include","layout","slot","template","span","div"],ADD_ATTR:["x-data","x-text","x-if","x-for","x-bind","x-on","src","name","@click",":class"]}),async fetchJSON(e,t=!0){try{const n=await fetch(e);if(!n.ok)throw new Error(`Failed to load JSON: ${e}`);const i=await n.json();if(t){const e=t=>{if("string"==typeof t)return DOMPurify.sanitize(t);if("object"==typeof t&&null!==t)for(let n in t)t[n]=e(t[n]);return t};return e(i)}return i}catch(e){return console.error(e),null}},async render(e,t){const n=document.getElementById(t);if(!n)return void console.error("Target element not found:",t);let i=await this.fetchHTML(e);i=await this.processLayout(i),i=await this.processIncludes(i),i=this.transformTemplate(i),n.innerHTML=i,this.executeScripts(n),window.Alpine&&setTimeout(async()=>{try{if("function"==typeof Alpine.initTree){if("function"==typeof Alpine.destroyTree)try{Alpine.destroyTree(n)}catch(e){console.warn("Alpine destroyTree warning:",e)}await Alpine.initTree(n),console.log("Alpine re-initialized for new content")}else"function"==typeof Alpine.init&&(Alpine.init(),console.log("Alpine initialized (legacy method)"))}catch(e){if(console.warn("Alpine initialization warning:",e),"function"==typeof Alpine.init)try{Alpine.init()}catch(e){console.error("Alpine init failed:",e)}}},100)},executeScripts(e){e.querySelectorAll("script").forEach(e=>{const t=document.createElement("script");Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(e.innerHTML)),document.head.appendChild(t),document.head.removeChild(t),e.remove()})}},document.addEventListener("alpine:init",()=>{Alpine.data("collection",e=>({items:[],loading:!0,error:null,async init(){this.loading=!0;const t=await Framework.fetchJSON(e);t?this.items=t:this.error="Failed to load data",this.loading=!1}})),Alpine.data("item",(e,t,n)=>({item:null,loading:!0,error:null,async init(){this.loading=!0;const i=await Framework.fetchJSON(e);i?(this.item=i.find(e=>e[t]===n),this.item||(this.error="Item not found")):this.error="Failed to load data",this.loading=!1}}))});